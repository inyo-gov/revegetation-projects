---
title: "Revegetation Compliance Results"
format: 
  html:
    toc: true
    toc-depth: 3
    anchor-sections: true
    smooth-scroll: true
    code-fold: true
    code-summary: "code"
    code-line-numbers: true
    code-overflow: wrap
    code-link: true
    html-math-method: katex
tbl-cap-location: top
---

# Compliance Summary

This section presents the key compliance metrics for revegetation efforts.

```{r setup, message = FALSE, warning = FALSE, echo=FALSE}
#| label: load-libraries

library(dplyr)
library(readr)
library(here)
library(DT)
library(sf)
library(gt)
library(gtExtras)
library(janitor)

# Source custom functions
source(here('code','functions.R'))

# --- Data Loading (from targets pipeline) ---
library(targets)
tar_load(r2_data)
tar_load(r3_data)
tar_load(parcel_sum_filtered)

# Assign to local variables for compatibility
r2 <- r2_data
r3 <- r3_data
parcel_sum_f <- parcel_sum_filtered

# --- Build compliance metrics by parcel and year ---
# 1) Parcel-average perennial cover (mean Cover with CI) from parcel_sum_f
cover_tbl <- parcel_sum_f %>%
  filter(year != 2022) %>%
  transmute(parcel, year, Cover = round(Cover, 1),
            CI_95_Cover_Lower = round(CI_95_Cover_Lower, 1), 
            CI_95_Cover_Upper = round(CI_95_Cover_Upper, 1), 
            n.transects)

# 2) Species with >=3 hits per parcel-year (Perennial only) from r2
count_3hit_tbl <- r2 %>%
  filter(Lifecycle == 'Perennial') %>%
  group_by(parcel, year, species) %>%
  summarise(species_hits = sum(hits), .groups = 'drop') %>%
  filter(species_hits >= 3) %>%
  group_by(parcel, year) %>%
  summarise(count_3hit_species = n(), .groups = 'drop')

# 3) Species richness (distinct perennial species) per parcel-year from r2
richness_tbl <- r2 %>%
  filter(Lifecycle == 'Perennial') %>%
  group_by(parcel, year) %>%
  summarise(sp_richness = n_distinct(species), .groups = 'drop')

# 4) Each transect has >=2% cover? from r3
transect_cover_summary <- r3 %>%
  filter(Lifecycle == 'Perennial', Veg_Type != 'weed') %>%
  group_by(parcel, year, transect) %>%
  summarise(total_hits = sum(hits, na.rm = TRUE),
            total_tcov = sum(tcov, na.rm = TRUE), .groups = 'drop') %>%
  mutate(meets_2_percent = ifelse(total_tcov >= 2, "Yes", "No"))

transect_summary_tbl <- transect_cover_summary %>%
  filter(year != 2022) %>%
  group_by(parcel, year) %>%
  summarise(transects_at_2_percent = paste0(sum(meets_2_percent == "Yes"), "/", n()), .groups = 'drop')

# 5) Presence of a grass species per parcel-year from r3
grass_presence_tbl <- r3 %>%
  filter(year != 2022, Lifeform == 'Grass') %>%
  group_by(parcel, year) %>%
  summarise(grass_species = n(), .groups = 'drop')

# --- Join into a single compliance table ---
compliance_table <- cover_tbl %>%
  left_join(count_3hit_tbl, by = c('parcel','year')) %>%
  left_join(richness_tbl, by = c('parcel','year')) %>%
  left_join(transect_summary_tbl, by = c('parcel','year')) %>%
  left_join(grass_presence_tbl, by = c('parcel','year')) %>%
  arrange(parcel, year)

# Display
datatable(
  compliance_table,
  options = list(
    autoWidth = TRUE,
    scrollX = TRUE,
    columnDefs = list(list(width = '100%', targets = "_all")),
    dom = 'Bfrtip',
    buttons = c('csv')
  ),
  extensions = 'Buttons',
  filter = 'top'
)
```
