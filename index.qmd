---
title: "Laws 90, 94, 95, 118, 129 2025 Monitoring Data Analysis"
format:
  html:
    grid:
      sidebar-width: 20px
      body-width: 1200px
    toc: true
    toc-depth: 3
    anchor-sections: true
    smooth-scroll: true
    code-fold: true
    code-summary: "code"
    code-line-numbers: true
    code-overflow: wrap
    code-link: true
    html-math-method: katex
tbl-cap-location: top   
affiliation: "Inyo County Water Department"
date: "2025-09-03"
date-modified: "2025-09-03"
citation:
  type: report
  container-title: "Data Report"
  publisher: "Inyo County Water Department"
  issued: "2025-09-03"
  url: https://github.com/inyo-gov/revegetation-projects
google-scholar: true
execute:
  sql:
    echo: fenced
  r:
    echo: true
---

# 

```{r setup, message=FALSE, warning=FALSE}
library(sf)
library(here)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(DT)
library(janitor)
library(ggplot2)  # For histograms and maps
library(targets)  # For loading pipeline data
source(here('code','functions.R'))
```

```{r controls, echo=FALSE}
# Flags to selectively run legacy or heavy-map sections
run_legacy <- FALSE
run_maps <- TRUE  # Enable histograms and maps
```

# 

## Revegetation Goals

1.  **Perennial Cover ≥ 10%**: Parcel-average native perennial cover must be 10% or greater
2.  **Species with ≥3 Hits ≥ 6**: At least six perennial species must have at least 3 hits within each parcel
3.  **Species Richness ≥ 10**: Each parcel must have at least 10 distinct perennial species
4.  **Transect Cover ≥ 2%**: Each individual transect must have at least 2% perennial cover
5.  **Grass Species Present**: At least one grass species must be present on each parcel

-   **✓**: Goal attained

-   **✗**: Goal not attained

-   **—**: No data available

```{r compliance-table-comprehensive, warning=FALSE, echo=FALSE}
#| tbl-cap: "Comprehensive Revegetation Goal Attainment by Parcel and Year. Shows three compliance scenarios: Original (no ATTO/ERNA), Capped (reference-based ATTO/ERNA limits), and Full (unlimited ATTO/ERNA). All other goals (species counts, richness, transect coverage, grass presence) remain consistent across scenarios."

# Load comprehensive compliance data from targets pipeline
library(DT)
library(targets)
library(dplyr)

# Load the comprehensive compliance target
tar_load(compliance_comprehensive_all)

# Create the comprehensive compliance table
comprehensive_table <- compliance_comprehensive_all %>%
  arrange(parcel, year) %>%
  select(
    parcel, year,
    cover_full = cover_status_full,
    cover_capped = cover_status_capped, 
    cover_original = cover_status_original,
    species_3hit_status,
    richness_status,
    transect_status,
    grass_status,
    compliance_summary
  )

# Create the datatable with optimized column widths and default 2025 filter
datatable(
  comprehensive_table,
  options = list(
    autoWidth = FALSE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '10%', targets = 0),    # parcel
      list(width = '6%', targets = 1),     # year
      list(width = '12%', targets = 2),    # full cover
      list(width = '12%', targets = 3),    # capped cover
      list(width = '12%', targets = 4),    # original cover
      list(width = '10%', targets = 5),    # species ≥3 hits
      list(width = '10%', targets = 6),    # species richness
      list(width = '10%', targets = 7),    # transect cover
      list(width = '10%', targets = 8),    # grass species
      list(width = '8%', targets = 9)      # compliance summary
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 20,
    searchCols = list(
      list(search = "2025"),  # Default filter for year column (index 1)
      rep(list(search = ""), 9)  # Empty search for other columns
    )
  ),
  extensions = 'Buttons',
  filter = 'top',
  colnames = c(
    "Parcel", "Year", 
    "Cover ≥10% (Full)", "Cover ≥10% (Capped)", "Cover ≥10% (Original)",
    "Species ≥3 Hits ≥6", "Species Richness ≥10", "All Transects ≥2%", "Grass Species ≥1",
    "Compliance"
  )
)
```

1.  **Full**: All perennial species including unlimited ATTO/ERNA (maximum potential)
2.  **Capped**: ATTO/ERNA cover is limited/capped to/at reference parcel averages (policy-based compliance). **LAW90/94/95**: Up to **0.176%**. **LAW118/129**: Up to **2.885%**
3.  **Original**: Perennial cover calculations exclude ERNA10 and ATTO species

```{r reference-parcel-summary, warning=FALSE}
#| tbl-cap: "Reference parcel ATTO/ERNA cover averages used for capping calculations"

# Create reference parcel summary table
reference_summary <- data.frame(
  Reference_Group = c("LAW90/94/95", "LAW118/129"),
  ATTO_Average = c("0.029%", "1.34%"),
  ERNA10_Average = c("0.165%", "1.54%"),
  Combined_Average = c("0.176%", "2.885%"),
  Transects = c("170", "87"),
  Policy_Cap = c("0.176%", "2.885%")
)

datatable(
  reference_summary,
  options = list(
    autoWidth = FALSE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '20%', targets = 0),    # reference group
      list(width = '15%', targets = 1:5)   # other columns
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 10
  ),
  extensions = 'Buttons',
  filter = 'top',
  colnames = c(
    "Reference Parcel Group", 
    "ATTO Average Cover", 
    "ERNA10 Average Cover", 
    "Combined ATTO+ERNA10", 
    "Total Transects",
    "Policy Implementation Cap"
  )
)
```