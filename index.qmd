---
title: "Laws 90, 94, 95, 118, 129 2025 Monitoring Data Analysis"
tbl-cap-location: top   
affiliation: "Inyo County Water Department"
date: "2025-09-03"
date-modified: "2025-09-03"
citation:
  type: report
  container-title: "Data Report"
  publisher: "Inyo County Water Department"
  issued: "2025-09-03"
  url: https://github.com/inyo-gov/revegetation-projects
google-scholar: true
execute:
  sql:
    echo: fenced
  r:
    echo: true
---

# 

```{r, message=FALSE, warning=FALSE}
library(sf)
library(here)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(DT)
library(janitor)
library(ggplot2)  # For histograms and maps
library(targets)  # For loading pipeline data
source(here('code','functions.R'))

# Load targets data
tar_load(reference_atto_erna_analysis)
tar_load(compliance_comprehensive_all)
```

```{r, echo=FALSE}
# Flags to selectively run legacy or heavy-map sections
run_legacy <- FALSE
run_maps <- TRUE  # Enable histograms and maps
```

# 

## Revegetation Goals

1.  **Perennial Cover ≥ 10%**: Parcel-average native perennial cover must be 10% or greater
2.  **Species with ≥3 Hits ≥ 6**: At least six perennial species must have at least 3 hits within each parcel
3.  **Species Richness ≥ 10**: Each parcel must have at least 10 distinct perennial species
4.  **Transect Cover ≥ 2%**: Each individual transect must have at least 2% perennial cover
5.  **Grass Species Present**: At least one grass species must be present on each parcel

-   **✓**: Goal attained

-   **✗**: Goal not attained

-   **—**: No data available

```{r, warning=FALSE, echo=FALSE}
#| tbl-cap: "Comprehensive Revegetation Goal Attainment by Parcel and Year. Shows three compliance scenarios: Original (no ATTO/ERNA), Capped (reference-based ATTO/ERNA limits), and Full (unlimited ATTO/ERNA). All other goals (species counts, richness, transect coverage, grass presence) remain consistent across scenarios."

# Load compliance data
library(DT)
library(targets)
library(dplyr)

# Load compliance target
tar_load(compliance_comprehensive_all)

# Create compliance table
comprehensive_table <- compliance_comprehensive_all %>%
  arrange(parcel, year) %>%
  select(
    parcel, year,
    cover_full = cover_status_full,
    cover_capped = cover_status_capped, 
    cover_original = cover_status_original,
    species_3hit_status,
    richness_status,
    transect_status,
    grass_status,
    compliance_summary
  )

# Create datatable
datatable(
  comprehensive_table,
  options = list(
    autoWidth = FALSE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '10%', targets = 0),    # parcel
      list(width = '6%', targets = 1),     # year
      list(width = '12%', targets = 2),    # full cover
      list(width = '12%', targets = 3),    # capped cover
      list(width = '12%', targets = 4),    # original cover
      list(width = '10%', targets = 5),    # species ≥3 hits
      list(width = '10%', targets = 6),    # species richness
      list(width = '10%', targets = 7),    # transect cover
      list(width = '10%', targets = 8),    # grass species
      list(width = '8%', targets = 9)      # compliance summary
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 20,
    searchCols = list(
      list(search = "2025"),  # Default filter for year column (index 1)
      rep(list(search = ""), 9)  # Empty search for other columns
    )
  ),
  extensions = 'Buttons',
  filter = 'top',
  colnames = c(
    "Parcel", "Year", 
    "Cover ≥10% (Full)", "Cover ≥10% (Capped)", "Cover ≥10% (Original)",
    "Species ≥3 Hits ≥6", "Species Richness ≥10", "All Transects ≥2%", "Grass Species ≥1",
    "Compliance"
  )
)
```

```{r, echo=FALSE}
# Calculate reference summary
law90_94_95_parcels <- c("LAW012", "LAW024", "LAW028", "LAW048", "LAW049", "LAW091", "LAW093", "LAW117", "LAW130", "LAW134")
law118_129_parcels <- c("LAW029", "LAW039", "LAW069", "LAW104", "LAW119", "PLC202", "PLC219", "PLC227", "PLC230")

# Get ATTO/ERNA averages
law90_94_95_2025 <- reference_atto_erna_analysis %>%
  filter(parcel %in% law90_94_95_parcels & year == 2025) %>%
  group_by(species) %>%
  summarise(avg_cover = mean(avg_cover, na.rm = TRUE), .groups = 'drop')

law118_129_2025 <- reference_atto_erna_analysis %>%
  filter(parcel %in% law118_129_parcels & year == 2025) %>%
  group_by(species) %>%
  summarise(avg_cover = mean(avg_cover, na.rm = TRUE), .groups = 'drop')

# Calculate averages
law90_94_95_combined <- law90_94_95_2025 %>% summarise(combined = sum(avg_cover, na.rm = TRUE)) %>% pull(combined)
law118_129_combined <- law118_129_2025 %>% summarise(combined = sum(avg_cover, na.rm = TRUE)) %>% pull(combined)

# Get values
law90_94_95_atto <- law90_94_95_2025 %>% filter(species == "ATTO") %>% pull(avg_cover)
law90_94_95_erna <- law90_94_95_2025 %>% filter(species == "ERNA10") %>% pull(avg_cover)
law118_129_atto <- law118_129_2025 %>% filter(species == "ATTO") %>% pull(avg_cover)
law118_129_erna <- law118_129_2025 %>% filter(species == "ERNA10") %>% pull(avg_cover)

# Count transects
law90_94_95_transects <- reference_atto_erna_analysis %>%
  filter(parcel %in% law90_94_95_parcels & year == 2025) %>%
  summarise(total = sum(n_transects, na.rm = TRUE)) %>% pull(total)

law118_129_transects <- reference_atto_erna_analysis %>%
  filter(parcel %in% law118_129_parcels & year == 2025) %>%
  summarise(total = sum(n_transects, na.rm = TRUE)) %>% pull(total)

# Create summary table
reference_summary <- data.frame(
  Reference_Group = c("LAW90/94/95", "LAW118/129"),
  ATTO_Average = c(paste0(round(law90_94_95_atto, 3), "%"), paste0(round(law118_129_atto, 3), "%")),
  ERNA10_Average = c(paste0(round(law90_94_95_erna, 3), "%"), paste0(round(law118_129_erna, 3), "%")),
  Combined_Average = c(paste0(round(law90_94_95_combined, 3), "%"), paste0(round(law118_129_combined, 3), "%")),
  Transects = c(as.character(law90_94_95_transects), as.character(law118_129_transects)),
  Policy_Cap = c(paste0(round(law90_94_95_combined, 3), "%"), paste0(round(law118_129_combined, 3), "%"))
)
```

1.  **Full**: All perennial species including unlimited ATTO/ERNA (maximum potential)
2.  **Capped**: ATTO/ERNA cover is limited to reference parcel averages (policy-based compliance). **LAW90/94/95**: Up to **`r paste0(round(law90_94_95_combined, 3), "%")`**. **LAW118/129**: Up to **`r paste0(round(law118_129_combined, 3), "%")`**
3.  **Original**: Perennial cover calculations exclude ERNA10 and ATTO species

**Note**: The capping works by limiting ATTO/ERNA cover to the reference parcel averages. For example, if a transect has 10% ERNA cover but the cap is 4.1%, only 4.1% is added to the original perennial cover (excluding ATTO/ERNA).

```{r, warning=FALSE}
#| tbl-cap: "Reference parcel ATTO/ERNA cover averages used for capping calculations"

datatable(
  reference_summary,
  options = list(
    autoWidth = FALSE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '20%', targets = 0),    # reference group
      list(width = '15%', targets = 1:5)   # other columns
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 10
  ),
  extensions = 'Buttons',
  filter = 'top',
  colnames = c(
    "Reference Parcel Group", 
    "ATTO Average Cover", 
    "ERNA10 Average Cover", 
    "Combined ATTO+ERNA10", 
    "Total Transects",
    "Policy Implementation Cap"
  )
)
```

---

## Citation

If you use this data or analysis in your work, please cite:

> Inyo County Water Department. (2025). *Laws 90, 94, 95, 118, 129 2025 Monitoring Data Analysis*. Data Report. Retrieved from https://github.com/inyo-gov/revegetation-projects

**© 2025 Inyo County, California. All rights reserved.**