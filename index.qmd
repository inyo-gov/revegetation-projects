---
title: "Laws 90, 94, 95, 118, 129 Monitoring Data Analysis"
tbl-cap-location: top   
affiliation: "Inyo County Water Department"
date: "2025-09-03"
date-modified: "2025-09-03"
citation:
  type: report
  container-title: "Data Report"
  publisher: "Inyo County Water Department"
  issued: "2025-09-03"
  url: https://github.com/inyo-gov/revegetation-projects
google-scholar: true
execute:
  echo: false
  warning: false
  message: false
---

# Laws 90, 94, 95, 118, 129 Monitoring Data Analysis

This analysis presents compliance data for revegetation parcels across multiple years (2022-2025). The data shows original perennial cover (excluding ATTO/ERNA/ATPO species), capped cover (with policy-based limits applied), and full cover (all species included) to assess compliance with revegetation goals.

## Revegetation Goals

The following goals must be met for successful revegetation:

1.  **Perennial Cover ≥ 10%**: Parcel-average native perennial cover must be 10% or greater.
2.  **Species with ≥3 Hits ≥ 6**: At least six perennial species must have at least 3 hits within each parcel.
3.  **Species Richness ≥ 10**: Each parcel must have at least 10 distinct perennial species.
4.  **Transect Cover ≥ 2%**: Each individual transect must have at least 2% perennial cover.
5.  **Grass Species Present**: At least one grass species must be present on each parcel.

**Legend:** - `✓`: Goal attained - `✗`: Goal not attained - `-`: No data available

```{r, message=FALSE, warning=FALSE}
library(sf)
library(here)
library(dplyr)
library(readr)
library(stringr)
library(tidyr)
library(DT)
library(janitor)
library(ggplot2)  # For histograms and maps
library(targets)  # For loading pipeline data
source(here('code','functions.R'))

# Load targets data
tar_load(reference_atto_erna_analysis)
tar_load(compliance_comprehensive_all)
```

```{r, echo=FALSE}
# Flags to selectively run legacy or heavy-map sections
run_legacy <- FALSE
run_maps <- TRUE  # Enable histograms and maps
```

# 

```{r, warning=FALSE, echo=FALSE}
#| tbl-cap: "Comprehensive Revegetation Goal Attainment by Parcel and Year. Shows three compliance scenarios: Original (no ATTO/ERNA/ATPO), Capped (policy-based ATTO/ERNA/ATPO limits), and Full (unlimited ATTO/ERNA/ATPO)."
#| column: screen

# Load compliance data
library(DT)
library(targets)
library(dplyr)

# Load compliance target
tar_load(compliance_comprehensive_all)

# Create compliance table
comprehensive_table <- compliance_comprehensive_all %>%
  arrange(parcel, year) %>%
  select(
    parcel, year,
    cover_full = cover_status_full,
    cover_capped = cover_status_capped, 
    cover_original = cover_status_original,
    species_3hit_status,
    richness_status,
    transect_status,
    grass_status,
    compliance_summary
  )

# Create datatable
datatable(
  comprehensive_table,
  options = list(
    autoWidth = TRUE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '10%', targets = 0),     # parcel
      list(width = '5%', targets = 1),      # year
      list(width = '12%', targets = 2),     # full cover
      list(width = '12%', targets = 3),     # capped cover
      list(width = '18%', targets = 4),     # original cover (Excl. ATTO/ERNA/ATPO)
      list(width = '12%', targets = 5),     # species ≥3 hits
      list(width = '12%', targets = 6),     # species richness
      list(width = '12%', targets = 7),     # transect cover
      list(width = '12%', targets = 8),     # grass species
      list(width = '7%', targets = 9)       # compliance summary
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 20
  ),
  extensions = 'Buttons',
  filter = 'top',
  width = '100%',
  escape = FALSE,  # Allow HTML in column names
  colnames = c(
    "Parcel", "Year", 
    "Cover ≥10%<br/>(Full)", "Cover ≥10%<br/>(Capped)", "Cover ≥10%<br/>(Excl. ATTO/ERNA/ATPO)",
    "Species<br/>≥3 Hits ≥6", "Species<br/>Richness ≥10", "All Transects<br/>≥2%", "Grass Species<br/>≥1",
    "Compliance"
  )
)
```

1.  **Full**: All perennial species including unlimited ATTO/ERNA/ATPO (maximum potential)
2.  **Capped**: ATTO/ERNA/ATPO cover is limited to policy-based caps. **LAW90/94/95**: 0.3% each for ERNA10 & ATTO. **LAW118/129**: 2% each for ERNA10 & ATTO, plus ATPO capped at 3% when present
3.  **Excl. ATTO/ERNA/ATPO**: Perennial cover calculations exclude ATTO, ERNA10, and ATPO species

## Species Cover Analysis for Revegetation Parcels

This table shows the average cover by species for each individual revegetation parcel (LAW090, LAW094, LAW095, and LAW129_118) for 2025. The average cover is calculated across ALL transects (including zeros for transects where the species was not detected), following the same statistical approach as the reference parcel analysis. This provides a true statistical average that accounts for the full sampling effort for each parcel.

```{r, echo=FALSE}
# Load revegetation data and calculate species cover
library(targets)
library(tidyr)
tar_load(r3_data)

# Calculate average cover by species for revegetation parcels
# Following the same approach as reference data: include ALL transects (with zeros)

# Get all revegetation parcels and their transects for 2025 only
# Use transect_unique to avoid duplication issues
revegetation_parcels <- r3_data %>%
  filter(parcel %in% c('LAW090', 'LAW094', 'LAW095', 'LAW129_118') & year == 2025) %>%
  select(parcel, year, transect_unique) %>%
  distinct() %>%
  mutate(
    reference_group = case_when(
      parcel %in% c('LAW090', 'LAW094', 'LAW095') ~ 'LAW90/94/95',
      parcel == 'LAW129_118' ~ 'LAW118/129 (Combined)',
      TRUE ~ 'Other'
    )
  ) %>%
  filter(reference_group != 'Other')

# Create complete grid of parcel-year-transect-species for all species (2025 only)
all_species <- r3_data %>%
  filter(parcel %in% c('LAW090', 'LAW094', 'LAW095', 'LAW129_118') & year == 2025) %>%
  select(species, Lifecycle) %>%
  distinct()

species_grid <- revegetation_parcels %>%
  crossing(all_species)

# Get actual species data (2025 only)
# Use transect_unique to avoid duplication issues
species_data <- r3_data %>%
  filter(parcel %in% c('LAW090', 'LAW094', 'LAW095', 'LAW129_118') & year == 2025) %>%
  group_by(parcel, year, transect_unique, species, Lifecycle) %>%
  summarise(
    transect_hits = sum(hits, na.rm = TRUE),
    transect_cover = sum(hits * 1/200 * 100, na.rm = TRUE),
    .groups = 'drop'
  )

# Join everything together, filling zeros for missing species
complete_reveg_data <- species_grid %>%
  left_join(species_data, by = c("parcel", "year", "transect_unique", "species", "Lifecycle")) %>%
  # Fill NA values with zeros for missing species data
  mutate(
    transect_hits = ifelse(is.na(transect_hits), 0, transect_hits),
    transect_cover = ifelse(is.na(transect_cover), 0, transect_cover)
  ) %>%
  # Average across transects for each parcel-species-lifecycle combination
  group_by(parcel, species, Lifecycle) %>%
  summarise(
    avg_cover_all_transects = mean(transect_cover, na.rm = TRUE),
    n_transects_total = n(),
    n_transects_with_species = sum(transect_hits > 0, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # Only show species with some cover
  filter(avg_cover_all_transects > 0) %>%
  arrange(parcel, desc(avg_cover_all_transects)) %>%
  mutate(
    avg_cover_all_transects = round(avg_cover_all_transects, 2)
  ) %>%
  # Rename for display
  rename(
    avg_cover = avg_cover_all_transects
  ) %>%
  # Create final table
  select(parcel, species, Lifecycle, avg_cover, n_transects_total, n_transects_with_species)

# Assign to the expected variable name
revegetation_species_cover <- complete_reveg_data
```

```{r, warning=FALSE}
#| tbl-cap: "Average cover by species for each individual revegetation parcel in 2025 (includes all transects, with zeros for missing species)."
#| column: screen

datatable(
  revegetation_species_cover,
  options = list(
    autoWidth = TRUE,
    scrollX = TRUE,
    columnDefs = list(
      list(width = '15%', targets = 0),     # Parcel
      list(width = '15%', targets = 1),     # Species
      list(width = '12%', targets = 2),     # Lifecycle
      list(width = '15%', targets = 3),     # Average Cover %
      list(width = '18%', targets = 4),     # Total Transects
      list(width = '25%', targets = 5)      # Transects with Species
    ),
    dom = 'Bfrtip',
    buttons = c('csv'),
    pageLength = 20
  ),
  rownames = FALSE,
  extensions = 'Buttons',
  filter = 'top',
  width = '100%',
  escape = FALSE,
  colnames = c(
    "Parcel",
    "Species",
    "Lifecycle",
    "Average<br/>Cover %",
    "Total<br/>Transects",
    "Transects<br/>with Species"
  )
)
```

------------------------------------------------------------------------